# FEEDER for REDIS

This README helps how to configure feeder to build a image

* Using "terrabrasilis-dashboard-api" 
  * -> https://github.com/Terrabrasilis/terrabrasilis-dashboard-api

* Pre-requisits: 
  *	Redis (https://redis.io/download)
  *	Java 8 version
  *	Maven 

----
1) Clone repository
----
git clone https://github.com/Terrabrasilis/terrabrasilis-dashboard-api.git

----
2) Verify version of Java and Maven
----
In terminal verify java version, must be the version 8
java -version
```
openjdk version "1.8.0_222"
OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~16.04.1-b10)
OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)
```

mvn --version 
```
Apache Maven 3.3.9
Maven home: /usr/share/maven
Java version: 1.8.0_221, vendor: Oracle Corporation
Java home: /usr/lib/jvm/jdk1.8.0_221/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "4.15.0-58-generic", arch: "amd64", family: "unix"
```
case error: sudo apt-get install maven

----
3) In Visual Studio Code (VSC) or other editor 
----
Open visual studio and open folder terrabrasilis-dashboard-api 

a)
 > open redis-feeder/pom.xml 

Alter tag:

``` <version> tag to h1.0.x </version>  ```

 > Save

## Whats is pom.xml? 

Learn about pom: https://maven.apache.org/guides/introduction/introduction-to-the-pom.html

b)
 > open redis-feeder/src/main/resources/application-homol.properties

Alter lines to insert the information: 

For PostgreSQL DB

```
...
spring.datasource.url=jdbc:postgresql://<DATABASE HOST IP>:5432/Dashboard-data-model-homologation
...
spring.datasource.username=<user name>
spring.datasource.password=<secret password>
...
```

## Redis Configuration

 Refer to https://docs.spring.io/spring-boot/docs/current/reference/html/common-application-properties.html
```
...
spring.redis.host=<HOST IP>
spring.redis.port=<HOST PORT>
...
```
 > Save

c)

 **WARNING**

c.1) If for homologation:

> open redis-feeder/src/main/resources/application-homol.properties

```
spring.datasource.url=jdbc:postgresql://<DATABASE HOST IP>:5432/Dashboard-data-model-homologation
spring.redis.host=<HOST IP>
spring.redis.port=<HOST PORT>
```
 > this port can be acquired in Portainer/Services/[search redis-api]/"dashboard-deforestation-homologation_redis-api-homologation"

 > alter "redis-feeder/src/main/java/info/terrabrasilis/redis/feeder/util/Constants.java"
lines 15 and 16:

1) test in localhost
line 15: // private static final String HOST = "http://localhost:3000"; 

2) test in master
line 16: private static final String HOST = "http://terrabrasilis2.dpi.inpe.br:30026"; 


c.2) If for production

 > open redis-feeder/src/main/resources/application-prod.properties

```
spring.datasource.url=jdbc:postgresql://<DATABASE HOST IP>:5432/Dashboard-data-model 
spring.redis.host=<HOST IP>
spring.redis.port=<HOST PORT>
```
 > this port can be acquired in Portainer/Services/[search deforestation]/"dashboard-deforestation_redis"

16: private static final String HOST = "http://terrabrasilis2.dpi.inpe.br:30026"; 


----
4) Execute in terminal
----
a)
In folder

```
cd redis-feeder/
sh docker/deploy-and-build.sh 
```

#### It will build an image to put in Docker hub TerraBrasilis

b) 
Log user terrabrasilis

```
docker login -> <dockerhub_user> <dockerhub_pass>
docker ps
```
c)
#### It will push an image to Docker hub TerraBrasilis
Put as parameter the tag altered in  step 3
```
./push.sh h1.0.x
...
The push refers to repository [docker.io/terrabrasilis/redis-feeder]
599e404bee58: Pushed 
ceaf9e1ebef5: Layer already exists 
9b9b7f3d56a0: Layer already exists 
f1b5933fe4b5: Layer already exists 
h1.0.2: digest: sha256:1a2cd2d78401a4309d07e735f1d68f912af3c7cda0b800a85438da42ac120c42 size: 1159
```
case error: alter permition to "push.sh"
chmod +x push.sh 

OBS.: Don't close this terminal

d) 
### Open site Docker Hub of user terrbrasilis to see new tag and image
link: https://cloud.docker.com/u/terrabrasilis/repository/docker/terrabrasilis/redis-feeder
Tags: lastest -> h1.0.x

----
5) Open Portainer TerraBrasilis
----
http://terrabrasilis.dpi.inpe.br/portainer/


a) "Stacks"
Stacks list - search for "feeder-homologation"

	# feeder-homologation - Remove
	# + Add stack
	## name:	feeder-homologation 
	## yaml: 
```
version: '3.2'
services:
  redis-feeder-homologation:
    image: terrabrasilis/redis-feeder:h1.0.x # <- WARNING: Alter tag by used in Step 3.a
    ports:
      - "8080"
    networks:
      - proxy
    environment:
      - "SPRING_PROFILES_ACTIVE=homol" # WARNING: prod: production / homol: homologation
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure

networks:
  proxy:
    external: true
```

	# Deploy the stack

a.1)
Return the Stack list 
	# Refresh


b) "Services"
Service list:
	# search for "feeder-homologation_redis-feeder-homologation"
	# open "feeder-homologation_redis-feeder-homologation"

Service details:
	# alter field "Image" with information generated by step (4): terrabrasilis/redis-feeder:h1.0.2@sha256:1a2cd2d78401a4309d07e735f1d68f912af3c7cda0b800a85438da42ac120c42
	# "Service logs"
	# Refresh
	# note the "Host port" in "Networks & ports", this port will be used in test

```
terrabrasilis/redis-feeder:"h1.0.1"(with name of new version)@"sha256:ee0ce5b9aa1d72ccfb8e4a975bccbf9db2ff67bf268eb89d4b20fa7c00700300"(copy and paste the sha generated by "./push.sh h1.0.1" end of file)
```

b.1)
Return the Service list 
	# Refresh
	

----
6) Test in terminal and navegator
----

-- To check the API production live: curl http://terrabrasilis2.dpi.inpe.br:"put_host_port_here"/api/v1/redis-feeder/ping

curl http://terrabrasilis2.dpi.inpe.br:30018/api/v1/redis-feeder/ping
```
[{"headers":{},"body":{"time":"2019-08-29T12:50:53.809","message":"I'm alive!"},"statusCode":"OK","statusCodeValue":200}
```

-- To check the API production live: http://terrabrasilis2.dpi.inpe.br:"put_host_port_here"/api/v1/redis-feeder/ping

http://terrabrasilis2.dpi.inpe.br:30018/api/v1/redis-feeder/ping
```
[{"headers":{},"body":{"time":"2019-08-29T12:53:14.241","message":"I'm alive!"},"statusCode":"OK","statusCodeValue":200}]
```

-- To check in Grafana:
Container: dashboard-deforestation-homologation_redis-api-homologation

http://terrabrasilis2.dpi.inpe.br:3000/d/hRVQUIkiz/terrabrasilis-monitor?refresh=5s&orgId=1&var-host=All&var-container=dashboard-deforestation-homologation_redis-homologation

And in Service log of the Portainer

----
7) Push in Github
----
Make commit and push "https://github.com/Terrabrasilis/terrabrasilis-dashboard-api.git" in GitHub

WARNING: "Does not commit the files in folder "redis-feeder/src/main/resources/" because of sensitive information as user/password etc.
application-homol.properties
application-prod.properties
...

Commit pom.xml

git status
git add pom.xml
git commit -m "Alter tag in pom.xml"
git status
git push https://github.com/Terrabrasilis/terrabrasilis-dashboard-api.git master

Verify in Terrabrasilis/terrabrasilis-dashboard-api (https://github.com/Terrabrasilis/terrabrasilis-dashboard-api/tree/master/redis-feeder)

----
8) Area Calcule
----
In VSC - 
Open folder redis-feeder/src/main/info/terrabrasilis/redis/feeder/service/
- FeatureVOService.java
- FilterVOService
